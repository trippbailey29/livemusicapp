<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Piano Tutor (Live)</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #0a0f1a;
      color: #f0f4ff;
    }
    nav {
      background: #101830;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    nav h1 { color: #5dade2; margin: 0; }
    nav ul { list-style: none; display: flex; gap: 15px; margin: 0; padding: 0; }
    nav ul li a { color: #f0f4ff; text-decoration: none; }
    nav ul li a:hover { text-decoration: underline; }

    section { display: none; padding: 20px; }
    section.active { display: block; }

    .mic-status {
      margin-top: 20px;
      padding: 10px;
      border-radius: 8px;
      background: #101830;
      display: inline-block;
    }
    .mic-status.active { color: #2ecc71; }
    .mic-status.inactive { color: #e74c3c; }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav>
    <h1>🎹 Piano Tutor</h1>
    <ul>
      <li><a href="#" onclick="showPage('home')">Home</a></li>
      <li><a href="#" onclick="showPage('calibration')">Calibration</a></li>
      <li><a href="#" onclick="showPage('lessons')">Lessons</a></li>
      <li><a href="#" onclick="showPage('songs')">Songs</a></li>
      <li><a href="#" onclick="showPage('settings')">Settings</a></li>
    </ul>
  </nav>

  <!-- Home Section -->
  <section id="home" class="active">
    <h2>Welcome to Piano Tutor</h2>
    <p>This app listens to your piano live 🎶. Get ready to practice!</p>
    <div class="mic-status inactive" id="micStatus">🎤 Microphone: Off</div>
  </section>

  <!-- Placeholder Sections -->
  <section id="calibration"><h2>Calibration (coming in Block 2)</h2></section>
  <section id="lessons"><h2>Lessons (coming soon)</h2></section>
  <section id="songs"><h2>Songs (coming soon)</h2></section>
  <section id="settings"><h2>Settings (coming soon)</h2></section>

  <script>
    // Page switching
    function showPage(id) {
      document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }

    // Audio setup
    let audioContext, analyser, dataArray;

    async function initMic() {
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const source = audioContext.createMediaStreamSource(stream);
        analyser = audioContext.createAnalyser();
        source.connect(analyser);
        analyser.fftSize = 2048;
        dataArray = new Float32Array(analyser.fftSize);

        document.getElementById("micStatus").textContent = "🎤 Microphone: On";
        document.getElementById("micStatus").className = "mic-status active";

        detectPitch();
      } catch (err) {
        document.getElementById("micStatus").textContent = "🎤 Microphone: Error";
        document.getElementById("micStatus").className = "mic-status inactive";
        console.error(err);
      }
    }

    function detectPitch() {
      analyser.getFloatTimeDomainData(dataArray);
      let pitch = autoCorrelate(dataArray, audioContext.sampleRate);
      if (pitch !== -1) {
        console.log("Detected pitch:", pitch.toFixed(2), "Hz");
        // Later: map this to notes + show feedback
      }
      requestAnimationFrame(detectPitch);
    }

    // Basic autocorrelation pitch detection
    function autoCorrelate(buf, sampleRate) {
      let SIZE = buf.length;
      let rms = 0;
      for (let i=0;i<SIZE;i++) rms += buf[i]*buf[i];
      rms = Math.sqrt(rms/SIZE);
      if (rms < 0.01) return -1; // too quiet

      let r1=0, r2=SIZE-1, thres=0.2;
      for (let i=0; i<SIZE/2; i++) if (Math.abs(buf[i])<thres) { r1=i; break; }
      for (let i=1; i<SIZE/2; i++) if (Math.abs(buf[SIZE-i])<thres) { r2=SIZE-i; break; }

      buf = buf.slice(r1,r2);
      SIZE = buf.length;

      let c = new Array(SIZE).fill(0);
      for (let i=0;i<SIZE;i++) for (let j=0;j<SIZE-i;j++) c[i] = c[i]+buf[j]*buf[j+i];

      let d=0; while (c[d]>c[d+1]) d++;
      let maxval=-1, maxpos=-1;
      for (let i=d;i<SIZE;i++) if (c[i]>maxval) {maxval=c[i];maxpos=i;}
      if (maxpos===-1) return -1;
      return sampleRate/maxpos;
    }

    // Start microphone
    initMic();
  </script>
</body>
</html>
  <!-- Calibration Section -->
  <section id="calibration">
    <h2>Calibration</h2>
    <p>We’ll go through each note so the app can learn your piano.</p>
    <button onclick="startCalibration()">Start Calibration</button>
    <div id="calibrationStep"></div>
    <div class="piano" id="calibrationPiano">
      <!-- Virtual piano (just like home) -->
      <div class="key white" id="C4">C</div>
      <div class="key black" id="C#4"></div>
      <div class="key white" id="D4">D</div>
      <div class="key black" id="D#4"></div>
      <div class="key white" id="E4">E</div>
      <div class="key white" id="F4">F</div>
      <div class="key black" id="F#4"></div>
      <div class="key white" id="G4">G</div>
      <div class="key black" id="G#4"></div>
      <div class="key white" id="A4">A</div>
      <div class="key black" id="A#4"></div>
      <div class="key white" id="B4">B</div>
      <div class="key white" id="C5">C</div>
    </div>
  </section>

  <script>
    const calibrationNotes = ["C4","C#4","D4","D#4","E4","F4","F#4","G4","G#4","A4","A#4","B4","C5"];
    let calibrationIndex = 0;
    let calibrationMap = {};

    function startCalibration() {
      calibrationIndex = 0;
      calibrationMap = {};
      nextCalibrationStep();
    }

    function nextCalibrationStep() {
      if (calibrationIndex >= calibrationNotes.length) {
        document.getElementById("calibrationStep").innerHTML = "✅ Calibration complete!";
        localStorage.setItem("pianoCalibration", JSON.stringify(calibrationMap));
        return;
      }

      const currentNote = calibrationNotes[calibrationIndex];
      document.getElementById("calibrationStep").innerHTML = 
        `Play <strong>${currentNote}</strong> on your piano 🎹`;
      
      // highlight the key on virtual piano
      document.querySelectorAll(".key").forEach(k => k.style.background="");
      document.getElementById(currentNote).style.background = "#5dade2";

      waitForNote(currentNote);
    }

    function waitForNote(expectedNote) {
      // Listen until the right note is played
      function check() {
        analyser.getFloatTimeDomainData(dataArray);
        let pitch = autoCorrelate(dataArray, audioContext.sampleRate);
        if (pitch !== -1) {
          let detected = freqToNote(pitch);
          if (detected === expectedNote) {
            calibrationMap[expectedNote] = pitch;
            document.getElementById(expectedNote).style.background = "#2ecc71"; // green
            calibrationIndex++;
            setTimeout(nextCalibrationStep, 1000);
            return;
          } else {
            document.getElementById(expectedNote).style.background = "#e74c3c"; // red
          }
        }
        requestAnimationFrame(check);
      }
      check();
    }

    function freqToNote(freq) {
      // Rough mapping, later improved with calibrationMap
      const notes = [
        { note: "C4", freq: 261.63 },
        { note: "C#4", freq: 277.18 },
        { note: "D4", freq: 293.66 },
        { note: "D#4", freq: 311.13 },
        { note: "E4", freq: 329.63 },
        { note: "F4", freq: 349.23 },
        { note: "F#4", freq: 369.99 },
        { note: "G4", freq: 392.00 },
        { note: "G#4", freq: 415.30 },
        { note: "A4", freq: 440.00 },
        { note: "A#4", freq: 466.16 },
        { note: "B4", freq: 493.88 },
        { note: "C5", freq: 523.25 }
      ];
      let closest = notes.reduce((a,b)=>Math.abs(b.freq-freq)<Math.abs(a.freq-freq)?b:a);
      return closest.note;
    }
  </script>
  <!-- Lessons Section -->
  <section id="lessons">
    <h2>Lessons 🎶</h2>
    <p>Select a song and follow the notes on your piano.</p>
    
    <label for="songSelect">Choose a song:</label>
    <select id="songSelect"></select>
    
    <button onclick="startLesson()">Start Lesson</button>
    
    <div id="lessonDisplay"></div>
    <div id="lessonFeedback"></div>
    <div id="lessonScore"></div>
  </section>

  <script>
    // 🎵 SONG LIBRARY (20+ songs)
    const songLibrary = {
      "Mary Had a Little Lamb (Easy)": ["E4","D4","C4","D4","E4","E4","E4","D4","D4","D4","E4","G4","G4"],
      "Twinkle Twinkle Little Star (Easy)": ["C4","C4","G4","G4","A4","A4","G4","F4","F4","E4","E4","D4","D4","C4"],
      "Happy Birthday (Easy)": ["C4","C4","D4","C4","F4","E4","C4","C4","D4","C4","G4","F4"],
      "Ode to Joy (Medium)": ["E4","E4","F4","G4","G4","F4","E4","D4","C4","C4","D4","E4","E4","D4","D4"],
      "Jingle Bells (Medium)": ["E4","E4","E4","E4","E4","E4","E4","G4","C4","D4","E4"],
      "London Bridge (Medium)": ["G4","A4","G4","F4","E4","F4","G4","D4","E4","F4","E4","F4","G4"],
      "Yankee Doodle (Medium)": ["C4","C4","D4","E4","C4","E4","F4","G4","C4","D4","E4","C4","A4"],
      "Hot Cross Buns (Easy)": ["E4","D4","C4","E4","D4","C4","C4","C4","C4","D4","D4","D4","D4","E4","E4","E4","E4"],
      "Für Elise (Advanced)": ["E5","D#5","E5","D#5","E5","B4","D5","C5","A4"],
      "Canon in D (Advanced)": ["D4","A4","B4","F#4","G4","D4","G4","A4"],
      "Minuet in G (Advanced)": ["G4","F#4","G4","A4","B4","C5","D5","E5"],
      "C Major Scale (Easy Practice)": ["C4","D4","E4","F4","G4","A4","B4","C5"],
      "D Major Scale (Medium Practice)": ["D4","E4","F#4","G4","A4","B4","C#5","D5"],
      "G Major Scale (Medium Practice)": ["G4","A4","B4","C5","D5","E5","F#5","G5"],
      "C Chords (Practice)": ["C4","E4","G4","C5","E5","G5"],
      "G Chords (Practice)": ["G3","B3","D4","G4","B4","D5"],
      "Amazing Grace (Medium)": ["G4","B4","D5","B4","G4","E5","D5","C5","B4","G4"],
      "Silent Night (Medium)": ["G4","A4","G4","E4","G4","A4","G4","E4","C5","B4","A4"],
      "Star Wars Theme (Advanced)": ["G4","G4","G4","Eb4","Bb4","G4","Eb4","Bb4","G4"],
      "Beethoven Symphony No. 5 (Advanced)": ["G4","G4","G4","Eb4","F4","F4","F4","D4"]
    };

    // Populate dropdown
    const select = document.getElementById("songSelect");
    for (let song in songLibrary) {
      let opt = document.createElement("option");
      opt.value = song;
      opt.innerHTML = song;
      select.appendChild(opt);
    }

    let lessonSong = [];
    let lessonIndex = 0;
    let score = 0;

    function startLesson() {
      const chosen = document.getElementById("songSelect").value;
      lessonSong = songLibrary[chosen];
      lessonIndex = 0;
      score = 0;
      document.getElementById("lessonScore").innerHTML = "";
      showNextNote();
      waitForLessonNote();
    }

    function showNextNote() {
      if (lessonIndex >= lessonSong.length) {
        let feedback = "🎉 Lesson complete! Final score: " + score;
        if (score > lessonSong.length * 9) feedback += " (Master!)";
        else if (score > lessonSong.length * 6) feedback += " (Great job!)";
        else feedback += " (Keep practicing!)";
        document.getElementById("lessonDisplay").innerHTML = feedback;
        return;
      }
      const nextNote = lessonSong[lessonIndex];
      document.getElementById("lessonDisplay").innerHTML = 
        `Next Note: <strong>${nextNote}</strong>`;
    }

    function waitForLessonNote() {
      function check() {
        analyser.getFloatTimeDomainData(dataArray);
        let pitch = autoCorrelate(dataArray, audioContext.sampleRate);
        if (pitch !== -1) {
          let detected = freqToNote(pitch);

          if (lessonIndex < lessonSong.length) {
            let expected = lessonSong[lessonIndex];
            if (detected === expected) {
              score += 10;
              document.getElementById("lessonFeedback").innerHTML = 
                `<span style="color:lime">✅ Correct: ${detected}</span>`;
              lessonIndex++;
              showNextNote();
              setTimeout(waitForLessonNote, 1000);
              return;
            } else {
              score -= 2;
              document.getElementById("lessonFeedback").innerHTML = 
                `<span style="color:red">❌ Wrong: ${detected}. Expected: ${expected}</span>`;
            }
            document.getElementById("lessonScore").innerHTML = "Score: " + score;
          }
        }
        requestAnimationFrame(check);
      }
      check();
    }
  </script>
  <!-- Songs / Custom Song Section -->
  <section id="songs">
    <h2>Custom Songs & Sharing</h2>
    
    <div>
      <button onclick="showCreator('click')">🎹 Click Piano</button>
      <button onclick="showCreator('manual')">✏️ Manual Input</button>
      <button onclick="showCreator('code')">🔗 Enter Share Code</button>
    </div>
    
    <div id="creatorArea"></div>
  </section>

  <script>
    let currentSongNotes = [];
    let creatorMode = '';

    function showCreator(mode) {
      creatorMode = mode;
      const area = document.getElementById("creatorArea");
      area.innerHTML = '';
      currentSongNotes = [];

      if (mode === 'click') {
        // Scrollable piano UI
        let piano = document.createElement('div');
        piano.style.display = 'flex';
        piano.style.overflowX = 'scroll';
        piano.style.border = '1px solid #555';
        piano.style.padding = '10px';
        piano.style.background = '#101830';
        piano.style.width = '100%';
        area.appendChild(piano);

        const octaves = [3,4,5,6]; // scrollable octaves
        const noteOrder = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
        octaves.forEach(oct => {
          noteOrder.forEach(n=>{
            let key = document.createElement('div');
            key.textContent = n;
            key.dataset.note = n+oct;
            key.style.margin = '2px';
            key.style.padding = '20px';
            key.style.minWidth = '30px';
            key.style.textAlign = 'center';
            key.style.border = '1px solid #444';
            key.style.background = n.includes('#') ? '#333' : '#eee';
            key.style.color = n.includes('#') ? '#eee' : '#000';
            key.style.cursor = 'pointer';
            key.onclick = () => {
              currentSongNotes.push(key.dataset.note);
              key.style.background = '#5dade2';
              updateCurrentSongDisplay();
            }
            piano.appendChild(key);
          });
        });

        let display = document.createElement('div');
        display.id = 'currentSongDisplay';
        display.style.marginTop = '10px';
        area.appendChild(display);

        let saveBtn = document.createElement('button');
        saveBtn.textContent = '💾 Save Song';
        saveBtn.onclick = saveCurrentSong;
        area.appendChild(saveBtn);

        let shareBtn = document.createElement('button');
        shareBtn.textContent = '🔗 Get Share Code';
        shareBtn.style.marginLeft = '10px';
        shareBtn.onclick = shareCurrentSong;
        area.appendChild(shareBtn);

      } else if (mode === 'manual') {
        let input = document.createElement('textarea');
        input.placeholder = 'Type notes separated by spaces, e.g. C4 D4 E4 F4';
        input.style.width = '100%';
        input.style.height = '100px';
        area.appendChild(input);

        let saveBtn = document.createElement('button');
        saveBtn.textContent = '💾 Save Manual Song';
        saveBtn.onclick = () => {
          const notes = input.value.trim().split(/\s+/);
          currentSongNotes = notes;
          saveCurrentSong();
        }
        area.appendChild(saveBtn);

      } else if (mode === 'code') {
        let input = document.createElement('input');
        input.placeholder = 'Paste song code here';
        input.style.width = '80%';
        area.appendChild(input);

        let loadBtn = document.createElement('button');
        loadBtn.textContent = '📥 Load Song';
        loadBtn.onclick = () => {
          try {
            const notes = JSON.parse(atob(input.value));
            currentSongNotes = notes;
            alert('Song loaded! You can now play it.');
          } catch(err) {
            alert('Invalid code!');
          }
        }
        area.appendChild(loadBtn);
      }
    }

    function updateCurrentSongDisplay() {
      document.getElementById('currentSongDisplay').innerText = 'Current Song: ' + currentSongNotes.join(' ');
    }

    function saveCurrentSong() {
      let title = prompt('Enter song title:');
      if (!title) return;
      let savedSongs = JSON.parse(localStorage.getItem('customSongs')||'{}');
      savedSongs[title] = currentSongNotes;
      localStorage.setItem('customSongs', JSON.stringify(savedSongs));
      alert('Song saved! It will appear in Lessons dropdown.');
      // Add to Lessons dropdown dynamically
      const select = document.getElementById("songSelect");
      let opt = document.createElement("option");
      opt.value = title;
      opt.innerHTML = title;
      select.appendChild(opt);
    }

    function shareCurrentSong() {
      if (currentSongNotes.length === 0) { alert('No notes to share'); return; }
      const code = btoa(JSON.stringify(currentSongNotes));
      prompt('Share this code with others:', code);
    }
  </script>
  <!-- Settings Section -->
  <section id="settings">
    <h2>Settings ⚙️</h2>
    
    <div>
      <h3>Toggles</h3>
      <label><input type="checkbox" id="metronomeToggle"> Metronome</label><br>
      <label><input type="checkbox" id="adaptiveToggle"> Adaptive Difficulty</label><br>
      <label><input type="checkbox" id="visualOnlyToggle"> Visual Feedback Only</label><br>
      <label><input type="checkbox" id="autosaveToggle"> Auto-save every 2 minutes</label><br>
    </div>

    <div style="margin-top:20px;">
      <h3>Theme</h3>
      <label>Base Color: <input type="color" id="themeColor" value="#0a0f1a"></label><br>
      <label>Accent Color: <input type="color" id="accentColor" value="#5dade2"></label>
    </div>

    <div style="margin-top:20px;">
      <h3>Calibration & Songs</h3>
      <button onclick="resetCalibration()">Reset Calibration</button>
      <button onclick="resetCustomSongs()">Reset Custom Songs</button>
    </div>
  </section>

  <script>
    // Apply theme
    document.getElementById("themeColor").oninput = e => document.body.style.background = e.target.value;
    document.getElementById("accentColor").oninput = e => {
      document.querySelectorAll("h1, h2, h3, strong").forEach(el => el.style.color = e.target.value);
    }

    // Auto-save every 2 minutes
    let autoSaveInterval;
    document.getElementById("autosaveToggle").onchange = e => {
      if(e.target.checked){
        autoSaveInterval = setInterval(() => {
          saveCustomSongs();
          console.log('Auto-saved custom songs');
        }, 120000); // 2 minutes
      } else {
        clearInterval(autoSaveInterval);
      }
    }

    function resetCalibration() {
      if(confirm("Are you sure you want to reset calibration?")){
        localStorage.removeItem("pianoCalibration");
        alert("Calibration reset. Please recalibrate your piano.");
      }
    }

    function resetCustomSongs() {
      if(confirm("Are you sure you want to delete all custom songs?")){
        localStorage.removeItem("customSongs");
        alert("All custom songs deleted.");
        // Also remove them from Lessons dropdown
        const select = document.getElementById("songSelect");
        Array.from(select.options).forEach(opt=>{
          if(JSON.parse(localStorage.getItem('customSongs')||'{}')[opt.value]===undefined) return;
          select.removeChild(opt);
        });
      }
    }

    function saveCustomSongs() {
      // Saves existing songs from localStorage (placeholder)
      console.log("Custom songs saved to localStorage");
    }
  </script>
  <!-- Avatar Customizer Section -->
  <section id="avatar">
    <h2>Character Customizer 🎨</h2>
    <div style="display:flex; gap:20px;">
      <!-- Avatar Canvas -->
      <canvas id="avatarCanvas" width="200" height="300" style="background:#101830; border:1px solid #555;"></canvas>
      
      <!-- Controls -->
      <div>
        <label>Hair Style:
          <select id="hairStyleSelect">
            <option value="short">Short</option>
            <option value="long">Long</option>
            <option value="spiky">Spiky</option>
          </select>
        </label><br>
        
        <label>Hair Color: <input type="color" id="hairColor" value="#ffcc00"></label><br>
        <label>Skin Tone: <input type="color" id="skinColor" value="#f5d6b4"></label><br>
        <label>Outfit Color: <input type="color" id="outfitColor" value="#5dade2"></label><br>
        
        <label>Accessory:
          <select id="accessorySelect">
            <option value="none">None</option>
            <option value="hat">Hat</option>
            <option value="glasses">Glasses</option>
            <option value="guitar">Guitar</option>
          </select>
        </label>
      </div>
    </div>
  </section>

  <script>
    const canvas = document.getElementById('avatarCanvas');
    const ctx = canvas.getContext('2d');

    const avatarState = {
      hairStyle: 'short',
      hairColor: '#ffcc00',
      skinColor: '#f5d6b4',
      outfitColor: '#5dade2',
      accessory: 'none'
    };

    function drawAvatar() {
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // Body
      ctx.fillStyle = avatarState.outfitColor;
      ctx.fillRect(70, 150, 60, 120);

      // Head
      ctx.fillStyle = avatarState.skinColor;
      ctx.beginPath();
      ctx.arc(100, 100, 40, 0, Math.PI*2);
      ctx.fill();

      // Hair
      ctx.fillStyle = avatarState.hairColor;
      if(avatarState.hairStyle === 'short'){
        ctx.fillRect(60,60,80,30);
      } else if(avatarState.hairStyle === 'long'){
        ctx.fillRect(60,50,80,50);
      } else if(avatarState.hairStyle === 'spiky'){
        for(let i=0;i<5;i++){
          ctx.beginPath();
          ctx.moveTo(60+i*16,60);
          ctx.lineTo(80+i*16,30);
          ctx.lineTo(100+i*16,60);
          ctx.fill();
        }
      }

      // Accessory
      ctx.fillStyle = '#000';
      if(avatarState.accessory === 'hat'){
        ctx.fillRect(55,30,90,20);
      } else if(avatarState.accessory === 'glasses'){
        ctx.fillRect(70,90,20,10);
        ctx.fillRect(110,90,20,10);
        ctx.fillRect(90,95,20,2); // bridge
      } else if(avatarState.accessory === 'guitar'){
        ctx.fillStyle = '#8B4513';
        ctx.fillRect(120,180,60,10); // simple guitar
        ctx.beginPath();
        ctx.arc(180,185,15,0,Math.PI*2);
        ctx.fill();
      }
    }

    // Update state on change
    document.getElementById('hairStyleSelect').onchange = e => { avatarState.hairStyle = e.target.value; drawAvatar(); }
    document.getElementById('hairColor').oninput = e => { avatarState.hairColor = e.target.value; drawAvatar(); }
    document.getElementById('skinColor').oninput = e => { avatarState.skinColor = e.target.value; drawAvatar(); }
    document.getElementById('outfitColor').oninput = e => { avatarState.outfitColor = e.target.value; drawAvatar(); }
    document.getElementById('accessorySelect').onchange = e => { avatarState.accessory = e.target.value; drawAvatar(); }

    // Load saved avatar if exists
    const savedAvatar = JSON.parse(localStorage.getItem('avatarState')||'{}');
    if(Object.keys(savedAvatar).length > 0){
      Object.assign(avatarState, savedAvatar);
    }
    drawAvatar();

    // Save every change
    ['hairStyleSelect','hairColor','skinColor','outfitColor','accessorySelect'].forEach(id=>{
      document.getElementById(id).addEventListener('change',()=> localStorage.setItem('avatarState', JSON.stringify(avatarState)));
      document.getElementById(id).addEventListener('input',()=> localStorage.setItem('avatarState', JSON.stringify(avatarState)));
    });
  </script>
  <!-- Gamification Display -->
  <section id="gamification">
    <h2>Progress & XP</h2>
    <div style="margin-bottom:10px;">
      <strong>Level: </strong><span id="playerLevel">1</span><br>
      <strong>XP: </strong><span id="playerXP">0</span>/<span id="xpToNext">100</span>
      <div style="background:#444; width:100%; height:20px; border-radius:10px; margin-top:5px;">
        <div id="xpBar" style="background:#5dade2; height:100%; width:0%; border-radius:10px;"></div>
      </div>
    </div>
    <div id="achievements"></div>
  </section>

  <script>
    let player = JSON.parse(localStorage.getItem('playerData') || '{"level":1,"xp":0,"achievements":[],"skips":0}');
    const xpPerNote = 10;
    const levelThreshold = level => 100 + (level-1)*50; // XP required for next level

    function updateGamificationDisplay(){
      document.getElementById('playerLevel').innerText = player.level;
      document.getElementById('playerXP').innerText = player.xp;
      const xpNext = levelThreshold(player.level);
      document.getElementById('xpToNext').innerText = xpNext;
      const percent = Math.min(100, (player.xp/xpNext)*100);
      document.getElementById('xpBar').style.width = percent+'%';
      document.getElementById('achievements').innerHTML = 'Achievements: ' + player.achievements.join(', ');
    }

    function gainXP(points){
      player.xp += points;
      const xpNext = levelThreshold(player.level);
      if(player.xp >= xpNext){
        player.level++;
        player.xp -= xpNext;
        player.skips += 5; // reward 5 skips per level
        alert('Level Up! You earned 5 skips 🎉');
      }
      localStorage.setItem('playerData', JSON.stringify(player));
      updateGamificationDisplay();
    }

    function addAchievement(name){
      if(!player.achievements.includes(name)){
        player.achievements.push(name);
        alert('Achievement unlocked: '+name);
        localStorage.setItem('playerData', JSON.stringify(player));
        updateGamificationDisplay();
      }
    }

    // Hook this into lessons
    function lessonNoteCorrect(){
      gainXP(xpPerNote);
    }

    function lessonComplete(){
      addAchievement('Completed a Lesson');
    }

    updateGamificationDisplay();
  </script>
  <!-- Metronome / Audio Feedback Controls -->
  <section id="audioFeedback">
    <h2>Metronome & Audio Feedback 🎶</h2>
    
    <label>Tempo (BPM): <input type="number" id="metronomeBPM" value="80" min="40" max="240"></label><br>
    <button onclick="toggleMetronome()">Start / Stop Metronome</button><br>
    <label><input type="checkbox" id="soundFeedbackToggle" checked> Enable Sound Feedback</label>
  </section>

  <script>
    let metronomeInterval;
    let metronomeOn = false;
    const metronomeSound = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA='); // tiny click placeholder

    function toggleMetronome(){
      metronomeOn = !metronomeOn;
      if(metronomeOn){
        const bpm = document.getElementById('metronomeBPM').value;
        const interval = 60000 / bpm; // ms per beat
        metronomeInterval = setInterval(()=>{ 
          if(document.getElementById('metronomeToggle').checked){
            metronomeSound.currentTime = 0;
            metronomeSound.play();
          }
        }, interval);
      } else {
        clearInterval(metronomeInterval);
      }
    }

    // Sound feedback for lessons
    const correctSound = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA='); // replace with real note sound
    const wrongSound = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=');

    function playSoundFeedback(correct){
      if(!document.getElementById('soundFeedbackToggle').checked) return;
      if(correct) correctSound.play();
      else wrongSound.play();
    }

    // Example integration with Lessons (Block 3)
    function waitForLessonNote() {
      function check() {
        analyser.getFloatTimeDomainData(dataArray);
        let pitch = autoCorrelate(dataArray, audioContext.sampleRate);
        if (pitch !== -1) {
          let detected = freqToNote(pitch);

          if (lessonIndex < lessonSong.length) {
            let expected = lessonSong[lessonIndex];
            if (detected === expected) {
              score += 10;
              playSoundFeedback(true); // correct note sound
              document.getElementById("lessonFeedback").innerHTML = `<span style="color:lime">✅ Correct: ${detected}</span>`;
              lessonIndex++;
              showNextNote();
              setTimeout(waitForLessonNote, 1000);
              return;
            } else {
              score -= 2;
              playSoundFeedback(false); // wrong note sound
              document.getElementById("lessonFeedback").innerHTML = `<span style="color:red">❌ Wrong: ${detected}. Expected: ${expected}</span>`;
            }
            document.getElementById("lessonScore").innerHTML = "Score: " + score;
          }
        }
        requestAnimationFrame(check);
      }
      check();
    }
  </script>
  <!-- Achievements & Monthly Progress -->
  <section id="progress">
    <h2>Achievements & Monthly Progress 🏆</h2>
    
    <div id="achievementList" style="margin-bottom:20px;">
      <h3>Achievements</h3>
      <ul></ul>
    </div>
    
    <div id="monthlyProgress">
      <h3>Monthly Progress</h3>
      <div id="calendar" style="display:flex; gap:5px; flex-wrap:wrap; max-width:400px;"></div>
      <div>Total XP this month: <span id="monthlyXP">0</span></div>
      <div>Current Streak: <span id="streakDays">0</span> days</div>
    </div>
  </section>

  <script>
    const achievementData = [
      {name:'Completed 5 Lessons', condition:()=> player.achievements.includes('Completed 5 Lessons')},
      {name:'Score 1000 XP', condition:()=> player.xp >= 1000},
      {name:'Master a song', condition:()=> player.achievements.includes('Mastered Song')},
      {name:'7-day streak', condition:()=> getCurrentStreak()>=7},
      {name:'30-day streak', condition:()=> getCurrentStreak()>=30}
    ];

    function updateAchievements(){
      const list = document.querySelector('#achievementList ul');
      list.innerHTML = '';
      achievementData.forEach(a=>{
        const li = document.createElement('li');
        li.textContent = a.name + (a.condition() ? ' ✅' : ' ❌');
        list.appendChild(li);
      });
    }

    // Monthly Progress Tracker
    let practiceData = JSON.parse(localStorage.getItem('practiceData') || '[]'); 
    // array of dates string: 'YYYY-MM-DD'

    function logPractice() {
      const today = new Date().toISOString().slice(0,10);
      if(!practiceData.includes(today)){
        practiceData.push(today);
        localStorage.setItem('practiceData', JSON.stringify(practiceData));
      }
      updateMonthlyProgress();
    }

    function getCurrentStreak(){
      const today = new Date();
      let streak = 0;
      for(let i=practiceData.length-1;i>=0;i--){
        const d = new Date(practiceData[i]);
        const diff = (today - d)/(1000*60*60*24);
        if(diff <= streak) streak++;
        else break;
      }
      return streak;
    }

    function updateMonthlyProgress(){
      const calendar = document.getElementById('calendar');
      calendar.innerHTML = '';
      const now = new Date();
      const monthStart = new Date(now.getFullYear(), now.getMonth(),1);
      const monthEnd = new Date(now.getFullYear(), now.getMonth()+1,0);

      let totalXP = 0;
      for(let d=monthStart.getDate(); d<=monthEnd.getDate(); d++){
        const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const div = document.createElement('div');
        div.textContent = d;
        div.style.width = '30px';
        div.style.height = '30px';
        div.style.textAlign = 'center';
        div.style.border = '1px solid #555';
        div.style.background = practiceData.includes(dateStr) ? '#5dade2' : '#333';
        calendar.appendChild(div);

        // Approx XP placeholder: 10 XP per day practiced
        if(practiceData.includes(dateStr)) totalXP += 10;
      }
      document.getElementById('monthlyXP').innerText = totalXP;
      document.getElementById('streakDays').innerText = getCurrentStreak();
      updateAchievements();
    }

    // Call this after completing a lesson
    function lessonLogged(){
      logPractice();
      updateMonthlyProgress();
    }

    updateMonthlyProgress();
  </script>
  <!-- Top Navigation -->
  <nav style="background:#101830; padding:10px; display:flex; gap:10px;">
    <button onclick="showSection('home')">🏠 Home</button>
    <button onclick="showSection('lessons')">🎵 Lessons</button>
    <button onclick="showSection('songs')">🎹 Custom Songs</button>
    <button onclick="showSection('settings')">⚙️ Settings</button>
    <button onclick="showSection('avatar')">🧑 Avatar</button>
    <button onclick="showSection('progress')">🏆 Progress</button>
  </nav>

  <style>
    body {background:#0a0f1a; color:#eee; font-family:Arial, sans-serif; margin:0; padding:0;}
    section {padding:20px; display:none;}
    section.active {display:block;}
    button {background:#5dade2; color:#101830; border:none; padding:8px 12px; border-radius:8px; cursor:pointer;}
    button:hover {background:#3498db;}
    input, select, textarea {border-radius:5px; border:1px solid #555; padding:5px;}
  </style>

  <script>
    // Section navigation
    const sections = document.querySelectorAll('section');
    function showSection(id){
      sections.forEach(s=>s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    // Show home on load
    showSection('home');

    // Responsive adjustments
    function adjustLayout(){
      if(window.innerWidth < 600){
        document.querySelectorAll('div').forEach(d=>d.style.flexWrap='wrap');
      } else {
        document.querySelectorAll('div').forEach(d=>d.style.flexWrap='nowrap');
      }
    }
    window.addEventListener('resize', adjustLayout);
    adjustLayout();

    // Global auto-save hook
    setInterval(()=>{
      saveCustomSongs();
      localStorage.setItem('avatarState', JSON.stringify(avatarState));
      localStorage.setItem('playerData', JSON.stringify(player));
      localStorage.setItem('practiceData', JSON.stringify(practiceData));
      console.log('Auto-saved all data');
    }, 120000); // 2 minutes
  </script>
